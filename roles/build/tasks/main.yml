- name: create build directory
  file:
    path: "{{ group_vars.build.dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Template a file to storage
  ansible.builtin.template:
    src: Dockerfile.j2
    dest: "{{ group_vars.build.dir }}/Dockerfile"
    mode: '0755'

- name: copy files
  copy:
    src: "./soft"
    dest: "{{ group_vars.build.dir }}"
    owner: root
    group: root
    mode: '0644'

- name: build container image
  docker_image:
    name: "{{ group_vars.build.image_name }}:{{ group_vars.build.version1c }}"
    source: build
    build:
      path: "{{ group_vars.build.dir }}"
    state: present

# - name: archive container image as a tarball
#   docker_image:
#     name: "{{ group_vars.build.image_name }}:{{ group_vars.build.version1c }}"
#     archive_path: "{{ group_vars.build.dir }}/{{ group_vars.build.image_name }}_{{ group_vars.build.version1c }}.tar"
#     source: pull
#     state: present

- name: archive container image as a tar
  community.docker.docker_image_export:
    name: "{{ group_vars.build.image_name }}:{{ group_vars.build.version1c }}"
    path: "{{ group_vars.build.dir }}/{{ group_vars.build.image_name }}_{{ group_vars.build.version1c }}.tar"
    
- name: fetch archived image
  fetch:
    src: "{{ group_vars.build.dir }}/{{ group_vars.build.image_name }}_{{ group_vars.build.version1c }}.tar"
    dest: ./soft/{{ group_vars.build.image_name }}_{{ group_vars.build.version1c }}.tar"
    flat: true